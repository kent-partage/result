<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P.Bパルタージェ 試合結果トラッカー</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font CDN -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* カスタムモーダルの背景 */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* メッセージ表示アニメーション */
        @keyframes bounce-in {
            0% { transform: translate(-50%, -100px); opacity: 0; }
            60% { transform: translate(-50%, 10px); opacity: 1; }
            100% { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-bounce-in {
            animation: bounce-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div id="root">
        <!-- React App will be mounted here -->
    </div>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- App Logic -->
    <script type="module">
        const { useState, useEffect, useCallback } = React;
        const { createRoot } = ReactDOM;

        // プレーヤーの初期リスト
        const initialPlayers = [
            'トシキ', 'サワ', 'ヒロキ', 'ムラヤマ', 'トモ', 'ヒビキ', 'ショウタ', 'ケイジ', 'ケイヤ', 'ヤマグチ', 'クボ', 'タカヒト', 'ノム', 'アベ'
        ];

        function App() {
            const [matches, setMatches] = useState([]);
            const [opponent, setOpponent] = useState('');
            const [pbScore, setPbScore] = useState('');
            const [opponentScore, setOpponentScore] = useState('');
            const [result, setResult] = useState(''); // 'win', 'lose', 'draw'
            const [selectedScorers, setSelectedScorers] = useState([]);
            const [players, setPlayers] = useState(initialPlayers); // アプリ内で管理するプレイヤーリスト
            const [newPlayerName, setNewPlayerName] = useState('');
            const [showPlayerModal, setShowPlayerModal] = useState(false); // 選手管理モーダルの表示状態
            const [loading, setLoading] = useState(true); // localStorageからの読み込みを待つためのローディング状態
            const [message, setMessage] = useState(''); // ユーザーへのメッセージ

            // メッセージ表示関数
            const showMessage = useCallback((text, duration = 3000) => {
                setMessage(text);
                const timer = setTimeout(() => {
                    setMessage('');
                }, duration);
                return () => clearTimeout(timer); // クリーンアップ関数を返す
            }, []);

            // アプリ起動時にlocalStorageからデータを読み込む
            useEffect(() => {
                try {
                    const storedMatches = localStorage.getItem('pb_palterge_matches');
                    if (storedMatches) {
                        setMatches(JSON.parse(storedMatches));
                    }
                } catch (error) {
                    console.error("ローカルストレージからのデータ読み込みエラー:", error);
                    showMessage('データの読み込みに失敗しました。: ' + error.message);
                } finally {
                    setLoading(false); // 読み込み完了
                }
            }, []);

            // matchesステートが変更されるたびにlocalStorageに保存する
            useEffect(() => {
                if (!loading) { // 初期ロードが完了した後にのみ保存を実行
                    try {
                        localStorage.setItem('pb_palterge_matches', JSON.stringify(matches));
                    } catch (error) {
                        console.error("ローカルストレージへのデータ保存エラー:", error);
                        showMessage('データの保存に失敗しました: ' + error.message);
                    }
                }
            }, [matches, loading, showMessage]);

            // 試合結果の計算
            const calculateResult = (pb, opp) => {
                if (pb === '' || opp === '') return '';
                const pbInt = parseInt(pb);
                const oppInt = parseInt(opp);
                if (pbInt > oppInt) return 'win';
                if (pbInt < oppInt) return 'lose';
                return 'draw';
            };

            // 試合結果の表示テキスト
            const getResultText = (res) => {
                if (res === 'win') return '勝ち';
                if (res === 'lose') return '負け';
                if (res === 'draw') return '引き分け';
                return '';
            };

            // 試合の追加
            const addMatch = () => {
                if (!opponent || pbScore === '' || opponentScore === '') {
                    showMessage('対戦チーム名とスコアは必須です。');
                    return;
                }

                const calculatedResult = calculateResult(pbScore, opponentScore);
                const newMatch = {
                    id: Date.now().toString(), // ユニークなIDを生成 (ミリ秒単位のタイムスタンプ)
                    date: new Date().toISOString().split('T')[0], // YYYY-MM-DD形式
                    opponent,
                    pbScore: parseInt(pbScore),
                    opponentScore: parseInt(opponentScore),
                    result: calculatedResult,
                    scorers: selectedScorers,
                    timestamp: new Date().getTime() // ソート用 (ミリ秒単位のタイムスタンプ)
                };

                // 既存のmatchesの先頭に追加して、日付降順ソートの代わりにする
                setMatches(prevMatches => [newMatch, ...prevMatches].sort((a, b) => b.timestamp - a.timestamp));
                showMessage('試合結果を追加しました。');

                // フォームをリセット
                setOpponent('');
                setPbScore('');
                setOpponentScore('');
                setResult('');
                setSelectedScorers([]);
            };

            // 試合の削除
            const deleteMatch = (id) => {
                showMessage('削除しています...');
                setMatches(prevMatches => prevMatches.filter(match => match.id !== id));
                showMessage('試合結果を削除しました。');
            };

            // 対戦チームごとの勝率計算
            const getWinRates = useCallback(() => {
                const stats = {};
                matches.forEach(match => {
                    if (!stats[match.opponent]) {
                        stats[match.opponent] = { total: 0, wins: 0, draws: 0, losses: 0 };
                    }
                    stats[match.opponent].total++;
                    if (match.result === 'win') stats[match.opponent].wins++;
                    else if (match.result === 'draw') stats[match.opponent].draws++;
                    else if (match.result === 'lose') stats[match.opponent].losses++;
                });

                const winRates = {};
                for (const opponentName in stats) {
                    const s = stats[opponentName];
                    const winPercentage = s.total > 0 ? ((s.wins / s.total) * 100).toFixed(1) : 0;
                    winRates[opponentName] = {
                        ...s,
                        winPercentage: `${winPercentage}%`
                    };
                }
                return winRates;
            }, [matches]);

            // 得点者ごとの総得点数計算
            const getTopScorers = useCallback(() => {
                const scorerGoals = {};
                matches.forEach(match => {
                    if (match.scorers && Array.isArray(match.scorers)) {
                        match.scorers.forEach(scorer => {
                            scorerGoals[scorer] = (scorerGoals[scorer] || 0) + 1;
                        });
                    }
                });

                // オブジェクトを配列に変換し、得点が多い順にソート
                return Object.entries(scorerGoals).sort(([, a], [, b]) => b - a);
            }, [matches]);

            // 選手追加モーダルを開く
            const openPlayerModal = () => setShowPlayerModal(true);
            // 選手追加モーダルを閉じる
            const closePlayerModal = () => setShowPlayerModal(false);

            // 新しい選手を追加
            const addNewPlayer = () => {
                if (newPlayerName && !players.includes(newPlayerName)) {
                    setPlayers([...players, newPlayerName]);
                    setNewPlayerName('');
                    showMessage('選手を追加しました。');
                } else if (players.includes(newPlayerName)) {
                    showMessage('この選手はすでに存在します。');
                }
            };

            // 選手を削除
            const deletePlayer = (playerToDelete) => {
                showMessage(`${playerToDelete}を選手リストから削除します...`);
                setPlayers(players.filter(p => p !== playerToDelete));
                showMessage('選手を削除しました。');
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100">
                        <div className="text-xl font-semibold text-gray-700">ロード中...</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 p-4 font-inter">
                    {/* メッセージ表示エリア */}
                    {message && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce-in">
                            {message}
                        </div>
                    )}

                    <h1 className="text-4xl font-bold text-center text-gray-800 mb-8 rounded-lg p-3 bg-white shadow-md">
                        P.Bパルタージェ 試合結果トラッカー
                    </h1>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* 試合結果入力フォーム */}
                        <div className="lg:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
                            <h2 className="text-2xl font-semibold text-gray-700 mb-4">試合結果入力</h2>
                            <div className="mb-4">
                                <label htmlFor="opponent" className="block text-gray-700 text-sm font-bold mb-2">対戦チーム名:</label>
                                <input
                                    type="text"
                                    id="opponent"
                                    className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                                    value={opponent}
                                    onChange={(e) => setOpponent(e.target.value)}
                                    placeholder="例: 強豪FC"
                                />
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">P.Bパルタージェ スコア:</label>
                                <input
                                    type="number"
                                    className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                                    value={pbScore}
                                    onChange={(e) => {
                                        setPbScore(e.target.value);
                                        setResult(calculateResult(e.target.value, opponentScore));
                                    }}
                                    min="0"
                                    placeholder="0"
                                />
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">対戦チーム スコア:</label>
                                <input
                                    type="number"
                                    className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                                    value={opponentScore}
                                    onChange={(e) => {
                                        setOpponentScore(e.target.value);
                                        setResult(calculateResult(pbScore, e.target.value));
                                    }}
                                    min="0"
                                    placeholder="0"
                                />
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">試合結果:</label>
                                <span className={`text-lg font-bold ${result === 'win' ? 'text-green-600' : result === 'lose' ? 'text-red-600' : result === 'draw' ? 'text-blue-600' : 'text-gray-500'}`}>
                                    {getResultText(result)}
                                </span>
                            </div>

                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2">得点者:</label>
                                <div className="flex flex-wrap gap-2 mb-2">
                                    {selectedScorers.map((scorer, index) => (
                                        <span key={index} className="flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                                            {scorer}
                                            <button
                                                onClick={() => setSelectedScorers(selectedScorers.filter(s => s !== scorer))}
                                                className="ml-1 text-blue-800 hover:text-blue-900 focus:outline-none"
                                            >
                                                &times;
                                            </button>
                                        </span>
                                    ))}
                                </div>
                                <select
                                    className="shadow border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 mb-2"
                                    onChange={(e) => {
                                        const scorer = e.target.value;
                                        if (scorer && !selectedScorers.includes(scorer)) {
                                            setSelectedScorers([...selectedScorers, scorer]);
                                        }
                                    }}
                                    value="" // 選択後にリセットするため空にする
                                >
                                    <option value="">得点者を選択...</option>
                                    {players.map(player => (
                                        <option key={player} value={player}>{player}</option>
                                    ))}
                                </select>
                                <button
                                    onClick={openPlayerModal}
                                    className="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200"
                                >
                                    選手管理
                                </button>
                            </div>

                            <button
                                onClick={addMatch}
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg w-full transition duration-300 transform hover:scale-105"
                            >
                                試合結果を記録
                            </button>
                        </div>

                        {/* 統計情報 */}
                        <div className="lg:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
                            <h2 className="text-2xl font-semibold text-gray-700 mb-4">統計情報</h2>

                            <h3 className="text-xl font-medium text-gray-600 mb-3">対戦チームとの勝率</h3>
                            {Object.keys(getWinRates()).length === 0 ? (
                                <p className="text-gray-500">まだ試合が記録されていません。</p>
                            ) : (
                                <ul className="space-y-2">
                                    {Object.entries(getWinRates()).map(([opponentName, stats]) => (
                                        <li key={opponentName} className="bg-gray-50 p-3 rounded-lg shadow-sm">
                                            <strong className="text-gray-800">{opponentName}:</strong>
                                            <span className="ml-2 text-gray-700">
                                                勝率 {stats.winPercentage} ({stats.wins}勝 / {stats.draws}分 / {stats.losses}敗, 全{stats.total}試合)
                                            </span>
                                        </li>
                                    ))}
                                </ul>
                            )}

                            <h3 className="text-xl font-medium text-gray-600 mt-6 mb-3">得点者ランキング</h3>
                            {getTopScorers().length === 0 ? (
                                <p className="text-gray-500">まだ得点者が記録されていません。</p>
                            ) : (
                                <ul className="space-y-2">
                                    {getTopScorers().map(([scorer, goals], index) => (
                                        <li key={scorer} className="bg-gray-50 p-3 rounded-lg shadow-sm flex justify-between items-center">
                                            <span className="text-gray-800 font-medium">
                                                {index + 1}. {scorer}
                                            </span>
                                            <span className="text-blue-600 font-bold text-lg">{goals} ゴール</span>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>

                        {/* 試合結果一覧 */}
                        <div className="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                            <h2 className="text-2xl font-semibold text-gray-700 mb-4">試合結果一覧</h2>
                            {matches.length === 0 ? (
                                <p className="text-gray-500">まだ試合結果がありません。上記フォームから追加してください。</p>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full bg-white rounded-lg">
                                        <thead className="bg-gray-200">
                                            <tr>
                                                <th className="py-2 px-4 text-left text-gray-600 font-bold text-sm rounded-tl-lg">日付</th>
                                                <th className="py-2 px-4 text-left text-gray-600 font-bold text-sm">対戦チーム</th>
                                                <th className="py-2 px-4 text-left text-gray-600 font-bold text-sm">結果</th>
                                                <th className="py-2 px-4 text-left text-gray-600 font-bold text-sm">スコア</th>
                                                <th className="py-2 px-4 text-left text-gray-600 font-bold text-sm">得点者</th>
                                                <th className="py-2 px-4 text-left text-gray-600 font-bold text-sm rounded-tr-lg">アクション</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {matches.map(match => (
                                                <tr key={match.id} className="border-b border-gray-200 hover:bg-gray-50">
                                                    <td className="py-2 px-4 text-gray-800 text-sm">{match.date}</td>
                                                    <td className="py-2 px-4 text-gray-800 text-sm">{match.opponent}</td>
                                                    <td className={`py-2 px-4 text-sm font-medium ${match.result === 'win' ? 'text-green-600' : match.result === 'lose' ? 'text-red-600' : 'text-blue-600'}`}>
                                                        {getResultText(match.result)}
                                                    </td>
                                                    <td className="py-2 px-4 text-gray-800 text-sm">{match.pbScore} - {match.opponentScore}</td>
                                                    <td className="py-2 px-4 text-gray-800 text-sm">
                                                        {match.scorers && match.scorers.length > 0 ? match.scorers.join(', ') : 'なし'}
                                                    </td>
                                                    <td className="py-2 px-4">
                                                        <button
                                                            onClick={() => deleteMatch(match.id)}
                                                            className="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-xs shadow-md transition duration-200"
                                                        >
                                                            削除
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* 選手管理モーダル */}
                    {showPlayerModal && ReactDOM.createPortal( // Portalを使用してDOMの別の場所にレンダリング
                        <div className="fixed inset-0 modal-overlay flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                                <h3 className="text-xl font-semibold text-gray-700 mb-4">選手管理</h3>
                                <div className="mb-4">
                                    <label htmlFor="new-player" className="block text-gray-700 text-sm font-bold mb-2">新しい選手名:</label>
                                    <input
                                        type="text"
                                        id="new-player"
                                        className="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400"
                                        value={newPlayerName}
                                        onChange={(e) => setNewPlayerName(e.target.value)}
                                        placeholder="例: 佐藤"
                                    />
                                    <button
                                        onClick={addNewPlayer}
                                        className="mt-3 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 w-full"
                                    >
                                        選手を追加
                                    </button>
                                </div>
                                <h4 className="text-lg font-medium text-gray-600 mb-2">現在の選手リスト:</h4>
                                <ul className="max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                                    {players.length === 0 ? (
                                        <li className="text-gray-500">選手がいません。</li>
                                    ) : (
                                        players.map(player => (
                                            <li key={player} className="flex justify-between items-center py-1.5 border-b border-gray-100 last:border-b-0">
                                                <span className="text-gray-800">{player}</span>
                                                <button
                                                    onClick={() => deletePlayer(player)}
                                                    className="bg-red-400 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded-full transition duration-200"
                                                >
                                                    削除
                                                </button>
                                            </li>
                                        ))
                                    )}
                                </ul>
                                <div className="mt-6 flex justify-end">
                                    <button
                                        onClick={closePlayerModal}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200"
                                    >
                                        閉じる
                                    </button>
                                </div>
                            </div>
                        </div>,
                        document.body // body直下にレンダリング
                    )}
                </div>
            );
        }

        // Reactアプリをroot要素にマウント
        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>